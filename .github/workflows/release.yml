name: Release (tag artifacts)

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to release (e.g., v1.2.3)'
        required: true

env:
  FLUTTER_VERSION: '3.41.2'

jobs:
  verify:
    name: Verify (analyze + tests)
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Generate code
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Analyze
        run: flutter analyze --no-fatal-infos

      - name: Run tests
        run: flutter test

  build-android:
    name: Build Android release artifacts
    runs-on: ubuntu-latest
    needs: verify
    permissions:
      contents: read
    env:
      RELEASE_TAG: ${{ github.event.inputs.tag || github.ref_name }}
      ANDROID_SIGNING_ENABLED: ${{ vars.ANDROID_SIGNING_ENABLED }}
      ANDROID_KEYSTORE_B64: ${{ secrets.ANDROID_KEYSTORE_B64 }}
      ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
      ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
      ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Generate code
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Prepare Android signing files (optional)
        if: ${{ env.ANDROID_SIGNING_ENABLED == 'true' }}
        run: |
          for var in ANDROID_KEYSTORE_B64 ANDROID_KEYSTORE_PASSWORD ANDROID_KEY_ALIAS ANDROID_KEY_PASSWORD; do
            if [ -z "${!var}" ]; then
              echo "Missing required Android signing secret: ${var}"
              exit 1
            fi
          done

          printf '%s' "${ANDROID_KEYSTORE_B64}" | base64 --decode > android/upload-keystore.jks 2>/dev/null || \
            printf '%s' "${ANDROID_KEYSTORE_B64}" | base64 -D > android/upload-keystore.jks

          {
            printf 'storePassword=%s\n' "${ANDROID_KEYSTORE_PASSWORD}"
            printf 'keyPassword=%s\n' "${ANDROID_KEY_PASSWORD}"
            printf 'keyAlias=%s\n' "${ANDROID_KEY_ALIAS}"
            printf 'storeFile=%s\n' "upload-keystore.jks"
          } > android/key.properties

      - name: Build Android artifacts
        run: |
          flutter build apk --release
          flutter build appbundle --release

      - name: Package Android artifacts
        run: |
          mkdir -p dist/android
          cp build/app/outputs/flutter-apk/app-release.apk "dist/android/iris-chat-${RELEASE_TAG}-android.apk"
          cp build/app/outputs/bundle/release/app-release.aab "dist/android/iris-chat-${RELEASE_TAG}-android.aab"
          cd dist
          zip -r "iris-chat-${RELEASE_TAG}-android.zip" android

      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-release-artifacts
          path: dist/iris-chat-${{ env.RELEASE_TAG }}-android.zip
          retention-days: 7

      - name: Cleanup Android signing files (optional)
        if: ${{ always() && env.ANDROID_SIGNING_ENABLED == 'true' }}
        run: rm -f android/key.properties android/upload-keystore.jks

  build-linux:
    name: Build Linux release artifacts
    runs-on: ubuntu-latest
    needs: verify
    permissions:
      contents: read
    env:
      RELEASE_TAG: ${{ github.event.inputs.tag || github.ref_name }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Install Linux build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang \
            cmake \
            ninja-build \
            pkg-config \
            libgtk-3-dev \
            liblzma-dev \
            libsecret-1-dev \
            libjsoncpp-dev

      - name: Enable Linux desktop
        run: flutter config --enable-linux-desktop

      - name: Get dependencies
        run: flutter pub get

      - name: Generate code
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Build Linux bundle
        run: flutter build linux --release

      - name: Package Linux artifacts
        run: |
          mkdir -p dist
          tar -C build/linux/x64/release -czf "dist/iris-chat-${RELEASE_TAG}-linux-x64.tar.gz" bundle

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-release-artifacts
          path: dist/iris-chat-${{ env.RELEASE_TAG }}-linux-x64.tar.gz
          retention-days: 7

  build-windows:
    name: Build Windows release artifacts
    runs-on: windows-latest
    needs: verify
    permissions:
      contents: read
    env:
      RELEASE_TAG: ${{ github.event.inputs.tag || github.ref_name }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Enable Windows desktop
        run: flutter config --enable-windows-desktop

      - name: Get dependencies
        run: flutter pub get

      - name: Generate code
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Build Windows app
        run: flutter build windows --release

      - name: Package Windows artifacts
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path dist | Out-Null
          Compress-Archive -Path build/windows/x64/runner/Release -DestinationPath dist/iris-chat-$env:RELEASE_TAG-windows-x64.zip

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-release-artifacts
          path: dist/iris-chat-${{ env.RELEASE_TAG }}-windows-x64.zip
          retention-days: 7

  build-macos:
    name: Build macOS release artifacts
    runs-on: macos-latest
    needs: verify
    permissions:
      contents: read
    env:
      RELEASE_TAG: ${{ github.event.inputs.tag || github.ref_name }}
      MACOS_SIGNING_ENABLED: ${{ vars.MACOS_SIGNING_ENABLED }}
      MACOS_NOTARIZATION_ENABLED: ${{ vars.MACOS_NOTARIZATION_ENABLED }}
      MACOS_SIGNING_IDENTITY: ${{ secrets.MACOS_SIGNING_IDENTITY }}
      MACOS_CERTIFICATE_P12: ${{ secrets.MACOS_CERTIFICATE_P12 }}
      MACOS_CERTIFICATE_PASSWORD: ${{ secrets.MACOS_CERTIFICATE_PASSWORD }}
      MACOS_KEYCHAIN_PASSWORD: ${{ secrets.MACOS_KEYCHAIN_PASSWORD }}
      MACOS_NOTARIZE_APPLE_ID: ${{ secrets.MACOS_NOTARIZE_APPLE_ID }}
      MACOS_NOTARIZE_APP_PASSWORD: ${{ secrets.MACOS_NOTARIZE_APP_PASSWORD }}
      MACOS_NOTARIZE_TEAM_ID: ${{ secrets.MACOS_NOTARIZE_TEAM_ID }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Enable macOS desktop
        run: flutter config --enable-macos-desktop

      - name: Get dependencies
        run: flutter pub get

      - name: Generate code
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Build macOS app (arm64)
        run: |
          flutter build macos --release --config-only
          xcodebuild \
            -workspace macos/Runner.xcworkspace \
            -scheme Runner \
            -configuration Release \
            -derivedDataPath build/macos \
            -destination 'platform=macOS,arch=arm64' \
            ARCHS=arm64 \
            ONLY_ACTIVE_ARCH=YES

      - name: Verify macOS native FFI is enabled
        run: |
          PBXPROJ="macos/Runner.xcodeproj/project.pbxproj"
          if [ ! -f "${PBXPROJ}" ]; then
            echo "Missing ${PBXPROJ}"
            exit 1
          fi

          if ! grep -q 'SWIFT_ACTIVE_COMPILATION_CONDITIONS = NATIVE_RUST_FFI_ENABLED;' "${PBXPROJ}"; then
            echo "Release/Profile macOS build is missing NATIVE_RUST_FFI_ENABLED."
            exit 1
          fi
          if ! grep -q 'SWIFT_ACTIVE_COMPILATION_CONDITIONS = "DEBUG NATIVE_RUST_FFI_ENABLED";' "${PBXPROJ}"; then
            echo "Debug macOS build is missing NATIVE_RUST_FFI_ENABLED."
            exit 1
          fi
          if ! grep -q 'libhashtree_ffi.a in Frameworks' "${PBXPROJ}"; then
            echo "macOS project is not linking libhashtree_ffi.a."
            exit 1
          fi
          if ! grep -q 'libndr_ffi.a in Frameworks' "${PBXPROJ}"; then
            echo "macOS project is not linking libndr_ffi.a."
            exit 1
          fi

      - name: Install macOS signing certificate (optional)
        if: ${{ env.MACOS_SIGNING_ENABLED == 'true' && env.MACOS_CERTIFICATE_P12 != '' && env.MACOS_CERTIFICATE_PASSWORD != '' && env.MACOS_SIGNING_IDENTITY != '' }}
        run: |
          KEYCHAIN_PATH="$RUNNER_TEMP/iris-chat-signing.keychain-db"
          KEYCHAIN_PASSWORD="${MACOS_KEYCHAIN_PASSWORD:-temp_signing_password}"
          CERT_PATH="$RUNNER_TEMP/macos-signing-cert.p12"

          printf '%s' "${MACOS_CERTIFICATE_P12}" | base64 --decode > "${CERT_PATH}" 2>/dev/null || \
            printf '%s' "${MACOS_CERTIFICATE_P12}" | base64 -D > "${CERT_PATH}"

          security create-keychain -p "${KEYCHAIN_PASSWORD}" "${KEYCHAIN_PATH}"
          security set-keychain-settings -lut 21600 "${KEYCHAIN_PATH}"
          security unlock-keychain -p "${KEYCHAIN_PASSWORD}" "${KEYCHAIN_PATH}"
          security import "${CERT_PATH}" -k "${KEYCHAIN_PATH}" -P "${MACOS_CERTIFICATE_PASSWORD}" \
            -T /usr/bin/codesign -T /usr/bin/security
          security set-key-partition-list -S apple-tool:,apple: -k "${KEYCHAIN_PASSWORD}" "${KEYCHAIN_PATH}"
          security list-keychains -d user -s "${KEYCHAIN_PATH}"
          security default-keychain -d user -s "${KEYCHAIN_PATH}"

          if ! security find-identity -v -p codesigning "${KEYCHAIN_PATH}" | grep -Fq "${MACOS_SIGNING_IDENTITY}"; then
            echo "Expected signing identity not found: ${MACOS_SIGNING_IDENTITY}"
            exit 1
          fi

      - name: Code sign macOS app (optional)
        if: ${{ env.MACOS_SIGNING_ENABLED == 'true' && env.MACOS_CERTIFICATE_P12 != '' && env.MACOS_CERTIFICATE_PASSWORD != '' && env.MACOS_SIGNING_IDENTITY != '' }}
        run: |
          APP_PATH="$(find build/macos/Build/Products/Release -maxdepth 1 -name '*.app' -print -quit)"
          if [ -z "${APP_PATH}" ]; then
            echo "No macOS .app bundle found in build output"
            exit 1
          fi

          if [ -f "macos/Runner/Release.entitlements" ]; then
            codesign --force --deep --options runtime --timestamp \
              --entitlements macos/Runner/Release.entitlements \
              --sign "${MACOS_SIGNING_IDENTITY}" \
              "${APP_PATH}"
          else
            codesign --force --deep --options runtime --timestamp \
              --sign "${MACOS_SIGNING_IDENTITY}" \
              "${APP_PATH}"
          fi

          codesign --verify --deep --strict --verbose=2 "${APP_PATH}"

      - name: Notarize macOS app (optional)
        if: ${{ env.MACOS_SIGNING_ENABLED == 'true' && env.MACOS_NOTARIZATION_ENABLED == 'true' && env.MACOS_CERTIFICATE_P12 != '' && env.MACOS_CERTIFICATE_PASSWORD != '' && env.MACOS_SIGNING_IDENTITY != '' && env.MACOS_NOTARIZE_APPLE_ID != '' && env.MACOS_NOTARIZE_APP_PASSWORD != '' && env.MACOS_NOTARIZE_TEAM_ID != '' }}
        run: |
          APP_PATH="$(find build/macos/Build/Products/Release -maxdepth 1 -name '*.app' -print -quit)"
          if [ -z "${APP_PATH}" ]; then
            echo "No macOS .app bundle found in build output"
            exit 1
          fi

          NOTARIZE_ZIP="$RUNNER_TEMP/iris-chat-notarize.zip"
          ditto -c -k --sequesterRsrc --keepParent "${APP_PATH}" "${NOTARIZE_ZIP}"

          xcrun notarytool submit "${NOTARIZE_ZIP}" \
            --apple-id "${MACOS_NOTARIZE_APPLE_ID}" \
            --password "${MACOS_NOTARIZE_APP_PASSWORD}" \
            --team-id "${MACOS_NOTARIZE_TEAM_ID}" \
            --wait

          xcrun stapler staple "${APP_PATH}"

      - name: Package macOS artifacts
        run: |
          mkdir -p dist
          APP_PATH="$(find build/macos/Build/Products/Release -maxdepth 1 -name '*.app' -print -quit)"
          if [ -z "${APP_PATH}" ]; then
            echo "No macOS .app bundle found in build output"
            exit 1
          fi
          ditto -c -k --sequesterRsrc --keepParent "${APP_PATH}" "dist/iris-chat-${RELEASE_TAG}-macos-arm64.zip"

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-release-artifacts
          path: dist/iris-chat-${{ env.RELEASE_TAG }}-macos-arm64.zip
          retention-days: 7

      - name: Cleanup macOS signing keychain (optional)
        if: ${{ always() && env.MACOS_SIGNING_ENABLED == 'true' && env.MACOS_CERTIFICATE_P12 != '' && env.MACOS_CERTIFICATE_PASSWORD != '' && env.MACOS_SIGNING_IDENTITY != '' }}
        run: |
          KEYCHAIN_PATH="$RUNNER_TEMP/iris-chat-signing.keychain-db"
          security delete-keychain "${KEYCHAIN_PATH}" || true
          rm -f "$RUNNER_TEMP/macos-signing-cert.p12" "$RUNNER_TEMP/iris-chat-notarize.zip"

  build-ios:
    name: Build iOS simulator artifacts
    runs-on: macos-latest
    needs: verify
    permissions:
      contents: read
    env:
      RELEASE_TAG: ${{ github.event.inputs.tag || github.ref_name }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Generate code
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Build iOS simulator app (debug)
        run: flutter build ios --simulator --debug

      - name: Package iOS artifacts
        run: |
          mkdir -p dist
          APP_PATH="$(find build/ios/iphonesimulator -maxdepth 1 -name '*.app' -print -quit)"
          if [ -z "${APP_PATH}" ]; then
            echo "No iOS simulator .app bundle found in build output"
            exit 1
          fi
          ditto -c -k --sequesterRsrc --keepParent "${APP_PATH}" "dist/iris-chat-${RELEASE_TAG}-ios-simulator-debug.zip"

      - name: Upload iOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-release-artifacts
          path: dist/iris-chat-${{ env.RELEASE_TAG }}-ios-simulator-debug.zip
          retention-days: 7

  release:
    name: Create GitHub Release
    needs:
      - build-android
      - build-linux
      - build-windows
      - build-macos
      - build-ios
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.tag || github.ref_name }}
          name: ${{ github.event.inputs.tag || github.ref_name }}
          draft: false
          prerelease: ${{ contains(github.event.inputs.tag || github.ref_name, '-') }}
          generate_release_notes: true
          files: artifacts/*
